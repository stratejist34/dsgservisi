---
import type { CollectionEntry } from 'astro:content';
import { getBlogFeaturedImage, getBlogExcerpt, getBlogCategory, getCategoryLogo, getCategoryLink } from '@utils/content';

interface Props {
  post: CollectionEntry<'blog'>;
  index?: number;
  size?: 'featured-large' | 'featured-small' | 'square-left' | 'rect-right' | 'rect-wide' | 'square-stack' | 'rect-regular';
}

const { post, index = 0, size = 'rect-regular' } = Astro.props;
const featuredImage = getBlogFeaturedImage(post);
const excerpt = getBlogExcerpt(post);
const categoryName = getBlogCategory(post);
const categoryLogo = getCategoryLogo(categoryName);
const categoryLink = getCategoryLink(categoryName);
const postTitle = post.data.title;
const postSlug = post.slug;

// Define heights and padding based on CSS grid sizes - ALL OVERLAY STYLE
const sizeConfig = {
  'featured-large': {
    height: 'h-full', // 3 rows x 200px = 600px
    padding: 'p-6 md:p-8',
    titleSize: 'text-2xl md:text-[32px]',
    showExcerpt: false,
  },
  'featured-small': {
    height: 'h-full', // 1 row x 200px = 200px
    padding: 'p-4 md:p-5',
    titleSize: 'text-sm md:text-base',
    showExcerpt: false,
  },
  'square-left': {
    height: 'h-full', // 2 rows x 200px = 400px
    padding: 'p-5 md:p-6',
    titleSize: 'text-lg md:text-[22px]',
    showExcerpt: false,
  },
  'rect-right': {
    height: 'h-full', // 2 rows x 200px = 400px
    padding: 'p-5 md:p-6',
    titleSize: 'text-xl md:text-[26px]',
    showExcerpt: false,
  },
  'rect-wide': {
    height: 'h-full', // 2 rows x 200px = 400px
    padding: 'p-5 md:p-6',
    titleSize: 'text-xl md:text-[26px]',
    showExcerpt: false,
  },
  'square-stack': {
    height: 'h-full', // 1 row x 200px = 200px
    padding: 'p-4 md:p-5',
    titleSize: 'text-sm md:text-base',
    showExcerpt: false,
  },
  'rect-regular': {
    height: 'h-full', // 2 rows x 200px = 400px
    padding: 'p-5 md:p-6',
    titleSize: 'text-base md:text-xl',
    showExcerpt: false,
  },
};

const config = sizeConfig[size] || sizeConfig['rect-regular'];
---

<article
  class="netflix-card premium-card group relative rounded-[1.6rem] overflow-hidden shadow-lg w-full h-full min-h-[200px] transition-transform duration-500 ease-out will-change-transform group-hover:-translate-y-1 group-hover:shadow-xl"
  style={`animation: fade-in-up 0.8s ease-out ${index * 0.1}s both;`}
>
  <!-- Background Image (Full Card Height) -->
  {featuredImage ? (
    <img
      src={featuredImage}
      alt={post.data.imageAlt || postTitle}
      class="absolute inset-0 w-full h-full object-cover transition-transform duration-700 ease-out group-hover:scale-115 group-hover:brightness-110"
      loading="lazy"
    />
  ) : (
    <div class="absolute inset-0 w-full h-full bg-gray-800 flex items-center justify-center text-white">
      <span>No Image</span>
    </div>
  )}
  
  {/* Refined Turkuaz Overlay - Daha hafif, koyu odak sağ üst */}
  <div class="card-overlay absolute inset-0 transition-all duration-500 z-10"></div>
  
  {/* Category Badge - Sağ Üst Köşe - Büyük Logo */}
  {categoryName && categoryLogo && (
    <a 
      href={categoryLink}
      class="absolute top-4 right-4 z-30 opacity-[.62] hover:opacity-100 transition-opacity duration-300 group/badge"
      title={categoryName}
    >
      <img 
        src={categoryLogo} 
        alt={categoryName}
        class="w-20 h-20 object-contain filter brightness-0 invert transition-[filter] duration-300 ease-out group-hover:brightness-100 group-hover:invert-0 hover:brightness-100 hover:invert-0"
        loading="lazy"
      />
    </a>
  )}
  
  {/* Content Overlay container kept for stacking context */}
  <div class={`relative z-20 w-full h-full ${config.padding}`}></div>

  {/* Full-width glass band with title (edge-to-edge) */}
  <div class="absolute inset-x-0 bottom-0 z-30">
    <div class="backdrop-blur-md bg-gradient-to-r from-slate-900/75 via-slate-800/45 to-white/10 border-t border-white/10">
      <a href={`/${postSlug}`} class="block focus:outline-none focus:ring-2 focus:ring-cyan/60">
        <h3 class={`font-display text-white ${config.titleSize} uppercase tracking-wide font-extrabold leading-tight px-5 py-4`}>{postTitle}</h3>
      </a>
    </div>
  </div>

  
</article>

<style>
  .netflix-card {
    transform-style: preserve-3d;
    backface-visibility: hidden;
    transition: transform 300ms cubic-bezier(0.2, 0.8, 0.2, 1), box-shadow 300ms ease;
  }

  .netflix-card.is-tilting {
    transition: transform 60ms linear;
  }

  .netflix-card:hover {
    box-shadow: 0 18px 40px rgba(0, 0, 0, 0.35), 0 6px 16px rgba(0, 0, 0, 0.25);
    z-index: 5;
  }

  .premium-card::before {
    content: "";
    position: absolute;
    inset: 0;
    border-radius: 1.3rem; /* ~30% larger than 2xl(1rem) */
    padding: 1px; /* border width */
    pointer-events: none;
    background: linear-gradient(120deg,
      rgba(245, 212, 128, 0.55) 0%,
      rgba(240, 179, 90, 0.35) 20%,
      rgba(255, 255, 255, 0.45) 50%,
      rgba(240, 179, 90, 0.35) 80%,
      rgba(245, 212, 128, 0.55) 100%
    );
    -webkit-mask: 
      linear-gradient(#000 0 0) content-box, 
      linear-gradient(#000 0 0);
    -webkit-mask-composite: xor;
            mask-composite: exclude;
    opacity: 0;
    filter: drop-shadow(0 8px 24px rgba(246, 206, 120, 0.12));
    transition: opacity 400ms ease, filter 600ms ease;
  }

  .premium-card:hover::before {
    opacity: 1;
    filter: drop-shadow(0 10px 28px rgba(246, 206, 120, 0.18));
  }

  /* subtle shine sweep */
  .premium-card::after {
    content: "";
    position: absolute;
    inset: 0;
    pointer-events: none;
    border-radius: 1.3rem;
    background: linear-gradient(100deg,
      rgba(255, 255, 255, 0) 20%,
      rgba(255, 255, 255, 0.35) 50%,
      rgba(255, 255, 255, 0) 80%
    );
    transform: translateX(-140%);
    opacity: 0;
    transition: transform 800ms ease, opacity 400ms ease;
  }

  .premium-card:hover::after {
    transform: translateX(140%);
    opacity: 0.12;
  }
  
  /* Lighter turquoise overlay with dark focus shifted toward top-right */
  .card-overlay {
    border-radius: inherit;
    background-image:
      radial-gradient(60% 60% at 72% 22%,
        rgba(16, 94, 106, 0.28) 0%,
        rgba(21, 125, 141, 0.16) 45%,
        rgba(26, 156, 176, 0.08) 65%,
        rgba(26, 156, 176, 0.00) 80%
      ),
      linear-gradient(135deg,
        rgba(21, 125, 141, 0.12) 0%,
        rgba(26, 156, 176, 0.06) 50%,
        rgba(26, 156, 176, 0.00) 90%
      );
  }

  .group:hover .card-overlay {
    background-image:
      radial-gradient(60% 60% at 72% 22%,
        rgba(16, 94, 106, 0.22) 0%,
        rgba(21, 125, 141, 0.14) 45%,
        rgba(26, 156, 176, 0.06) 65%,
        rgba(26, 156, 176, 0.00) 80%
      ),
      linear-gradient(135deg,
        rgba(21, 125, 141, 0.10) 0%,
        rgba(26, 156, 176, 0.05) 50%,
        rgba(26, 156, 176, 0.00) 90%
      );
  }
</style>

<script>
  // @ts-nocheck
  const prefersReducedMotion = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;

  function setupNetflixCardTilt(card) {
    let rect = null;
    let rafId = 0;

    function onEnter() {
      rect = card.getBoundingClientRect();
      card.style.willChange = 'transform';
    }

    function onMove(e) {
      if (prefersReducedMotion) return;
      if (!rect) rect = card.getBoundingClientRect();
      const px = (e.clientX - rect.left) / rect.width; // 0..1
      const py = (e.clientY - rect.top) / rect.height; // 0..1
      const rotateY = (px - 0.5) * 16; // left/right
      const rotateX = (0.5 - py) * 12; // up/down
      const translateY = -10; // lift
      const scale = 1.04;

      card.classList.add('is-tilting');
      cancelAnimationFrame(rafId);
      rafId = requestAnimationFrame(() => {
        card.style.transform = `perspective(1000px) translateY(${translateY}px) scale(${scale}) rotateX(${rotateX}deg) rotateY(${rotateY}deg)`;
      });
    }

    function onLeave() {
      card.classList.remove('is-tilting');
      card.style.transition = 'transform 500ms cubic-bezier(0.2, 0.8, 0.2, 1), box-shadow 400ms ease';
      card.style.transform = '';
      rect = null;
      setTimeout(() => {
        card.style.transition = '';
        card.style.willChange = '';
      }, 520);
    }

    card.addEventListener('mouseenter', onEnter);
    card.addEventListener('mousemove', onMove);
    card.addEventListener('mouseleave', onLeave);
  }

  // Init on load
  const cards = document.querySelectorAll('.netflix-card');
  cards.forEach(setupNetflixCardTilt);
</script>
