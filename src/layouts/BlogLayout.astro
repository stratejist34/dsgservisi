---
import BaseLayout from './BaseLayout.astro';
import Schema from '@components/seo/Schema.astro';
import { SITE_CONFIG } from '@utils/constants';
import type { WPPost } from '@utils/wordpress';

interface Props {
  post: WPPost;
}

const { post } = Astro.props;

// Site URL (Astro.site kullan, fallback ekle)
const SITE_URL = Astro.site?.href.replace(/\/$/, '') || 'https://dsgservisi.com';

// BaseLayout için doğru props formatı
const title = post.yoast_head_json?.title || post.title.rendered;
const description = post.yoast_head_json?.description || post.excerpt.rendered.replace(/<[^>]*>/g, '').substring(0, 160);
const image = post._embedded?.['wp:featuredmedia']?.[0]?.source_url || '/images/default-blog.jpg';

// Article Schema
const articleSchema = {
  title: post.title.rendered,
  description: description,
  image: image,
  datePublished: post.date,
  dateModified: post.date,
  author: post._embedded?.author?.[0]?.name || SITE_CONFIG.name,
};

// Breadcrumb Schema
const breadcrumbData = {
  itemListElement: [
    {
      '@type': 'ListItem',
      position: 1,
      name: 'Ana Sayfa',
      item: SITE_URL,
    },
    {
      '@type': 'ListItem',
      position: 2,
      name: 'Blog',
      item: `${SITE_URL}/blog`,
    },
    {
      '@type': 'ListItem',
      position: 3,
      name: post.title.rendered,
      item: `${SITE_URL}/${post.slug}`,
    },
  ],
};

// LocalBusiness Schema with Reviews
const localServiceSchema = {
  '@context': 'https://schema.org',
  '@type': 'LocalBusiness',
  '@id': SITE_URL,
  name: SITE_CONFIG.name,
  image: image,
  description: description,
  url: `${SITE_URL}/${post.slug}`,
  telephone: SITE_CONFIG.phoneFormatted,
  email: SITE_CONFIG.email,
  priceRange: '$$',
  address: {
    '@type': 'PostalAddress',
    streetAddress: SITE_CONFIG.address.street,
    addressLocality: SITE_CONFIG.address.city,
    addressRegion: SITE_CONFIG.address.state,
    postalCode: SITE_CONFIG.address.postalCode,
    addressCountry: 'TR',
  },
  geo: {
    '@type': 'GeoCoordinates',
    latitude: SITE_CONFIG.coordinates.latitude,
    longitude: SITE_CONFIG.coordinates.longitude,
  },
  aggregateRating: {
    '@type': 'AggregateRating',
    ratingValue: SITE_CONFIG.google.rating.toString(),
    bestRating: '5',
    worstRating: '1',
    reviewCount: SITE_CONFIG.google.reviewCount.toString(),
  },
  review: [
    {
      '@type': 'Review',
      reviewRating: {
        '@type': 'Rating',
        ratingValue: '5',
        bestRating: '5',
      },
      author: {
        '@type': 'Person',
        name: 'Furkan Kaplan',
      },
      reviewBody: 'DSG şanzıman arızasını çok kısa sürede ve uygun fiyata hallettiler. Kesinlikle tavsiye ederim.',
    },
    {
      '@type': 'Review',
      reviewRating: {
        '@type': 'Rating',
        ratingValue: '5',
        bestRating: '5',
      },
      author: {
        '@type': 'Person',
        name: 'İsmail Susam',
      },
      reviewBody: 'Audi A4\'ümün DSG mekatronik tamirini yaptırdım. İşlerinde çok titizler ve uzman kadroları var.',
    },
    {
      '@type': 'Review',
      reviewRating: {
        '@type': 'Rating',
        ratingValue: '4',
        bestRating: '5',
      },
      author: {
        '@type': 'Person',
        name: 'Ahmet Yılmaz',
      },
      reviewBody: 'VW Passat DSG yağ değişimi için gittim. Fiyatlar makul ve işçilik kaliteli.',
    },
  ],
  openingHoursSpecification: [
    {
      '@type': 'OpeningHoursSpecification',
      dayOfWeek: ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'],
      opens: '09:00',
      closes: '18:00',
    },
  ],
  areaServed: [
    {
      '@type': 'City',
      name: 'Büyükçekmece',
    },
    {
      '@type': 'City',
      name: 'Beylikdüzü',
    },
    {
      '@type': 'City',
      name: 'Esenyurt',
    },
    {
      '@type': 'City',
      name: 'Avcılar',
    },
  ],
  hasOfferCatalog: {
    '@type': 'OfferCatalog',
    name: 'Otomotiv Servis Hizmetleri',
    itemListElement: [
      {
        '@type': 'Offer',
        itemOffered: {
          '@type': 'Service',
          name: 'DSG Şanzıman Tamiri',
          description: 'DSG şanzıman ve mekatronik onarımı',
        },
      },
      {
        '@type': 'Offer',
        itemOffered: {
          '@type': 'Service',
          name: 'Periyodik Bakım',
          description: 'Düzenli araç bakım hizmetleri',
        },
      },
    ],
  },
};
---

<BaseLayout title={title} description={description} image={image}>
  <Fragment slot="head">
    {/* Article Schema */}
    <Schema type="article" article={articleSchema} />
    
    {/* LocalBusiness Schema with Reviews */}
    <script type="application/ld+json" set:html={JSON.stringify(localServiceSchema)} />
    
    {/* Breadcrumb Schema */}
    <Schema type="BreadcrumbList" data={breadcrumbData} />
    
    {/* Open Graph */}
    <meta property="og:type" content="article" />
    <meta property="og:image" content={image} />
  </Fragment>
  
  <slot />
</BaseLayout>