---
import BaseLayout from './BaseLayout.astro';
import Schema from '@components/seo/Schema.astro';
import { SITE_CONFIG } from '@utils/constants';
import type { WPPost } from '@utils/wordpress';

interface Props {
  post: WPPost;
}

const { post } = Astro.props;

const seo = {
  title: post.yoast_head_json?.title || post.title.rendered,
  description: post.yoast_head_json?.description || post.excerpt.rendered.replace(/<[^>]*>/g, '').substring(0, 160),
  image: post._embedded?.['wp:featuredmedia']?.[0]?.source_url || '/images/default-blog.jpg',
  url: `/${post.slug}`,
  type: 'article' as const,
  article: {
    publishedTime: post.date,
    modifiedTime: post.date,
  },
};

const articleSchema = {
  title: post.title.rendered,
  description: seo.description,
  image: seo.image,
  datePublished: post.date,
  dateModified: post.date,
  url: `${import.meta.env.PUBLIC_SITE_URL}/${post.slug}`,
};

// Local Business Service Schema for service-related blog posts
const localServiceSchema = {
  '@context': 'https://schema.org',
  '@type': 'LocalBusiness',
  '@id': import.meta.env.PUBLIC_SITE_URL,
  name: SITE_CONFIG.name,
  image: seo.image,
  description: seo.description,
  url: `${import.meta.env.PUBLIC_SITE_URL}/${post.slug}`,
  telephone: SITE_CONFIG.phoneFormatted,
  email: SITE_CONFIG.email,
  priceRange: '$$',
  address: {
    '@type': 'PostalAddress',
    streetAddress: SITE_CONFIG.address.street,
    addressLocality: SITE_CONFIG.address.city,
    addressRegion: SITE_CONFIG.address.state,
    postalCode: SITE_CONFIG.address.postalCode,
    addressCountry: 'TR',
  },
  geo: {
    '@type': 'GeoCoordinates',
    latitude: SITE_CONFIG.coordinates.latitude,
    longitude: SITE_CONFIG.coordinates.longitude,
  },
  aggregateRating: {
    '@type': 'AggregateRating',
    ratingValue: SITE_CONFIG.google.rating.toString(),
    bestRating: '5',
    worstRating: '1',
    reviewCount: SITE_CONFIG.google.reviewCount.toString(),
  },
  review: [
    {
      '@type': 'Review',
      reviewRating: {
        '@type': 'Rating',
        ratingValue: '5',
        bestRating: '5',
      },
      author: {
        '@type': 'Person',
        name: 'Furkan Kaplan',
      },
      reviewBody: 'DSG şanzıman arızasını çok kısa sürede ve uygun fiyata hallettiler. Kesinlikle tavsiye ederim.',
    },
    {
      '@type': 'Review',
      reviewRating: {
        '@type': 'Rating',
        ratingValue: '5',
        bestRating: '5',
      },
      author: {
        '@type': 'Person',
        name: 'İsmail Susam',
      },
      reviewBody: 'Audi A4\'ümün DSG mekatronik tamirini yaptırdım. İşlerinde çok titizler ve uzman kadroları var.',
    },
    {
      '@type': 'Review',
      reviewRating: {
        '@type': 'Rating',
        ratingValue: '4',
        bestRating: '5',
      },
      author: {
        '@type': 'Person',
        name: 'Ahmet Yılmaz',
      },
      reviewBody: 'VW Passat DSG yağ değişimi için gittim. Fiyatlar makul ve işçilik kaliteli.',
    },
  ],
  openingHoursSpecification: [
    {
      '@type': 'OpeningHoursSpecification',
      dayOfWeek: ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'],
      opens: '09:00',
      closes: '18:00',
    },
  ],
  areaServed: [
    {
      '@type': 'City',
      name: 'Büyükçekmece',
    },
    {
      '@type': 'City',
      name: 'Beylikdüzü',
    },
    {
      '@type': 'City',
      name: 'Esenyurt',
    },
    {
      '@type': 'City',
      name: 'Avcılar',
    },
  ],
  hasOfferCatalog: {
    '@type': 'OfferCatalog',
    name: 'Otomotiv Servis Hizmetleri',
    itemListElement: [
      {
        '@type': 'Offer',
        itemOffered: {
          '@type': 'Service',
          name: 'DSG Şanzıman Tamiri',
          description: 'DSG şanzıman ve mekatronik onarımı',
        },
      },
      {
        '@type': 'Offer',
        itemOffered: {
          '@type': 'Service',
          name: 'Periyodik Bakım',
          description: 'Düzenli araç bakım hizmetleri',
        },
      },
    ],
  },
};
---

<BaseLayout seo={seo}>
  <!-- Article Schema -->
  <Schema type="Article" data={articleSchema} />
  
  <!-- Local Business Service Schema with Reviews -->
  <script type="application/ld+json" set:html={JSON.stringify(localServiceSchema)} />
  
  <!-- Breadcrumb Schema -->
  <Schema 
    type="BreadcrumbList" 
    data={{
      items: [
        {
          '@type': 'ListItem',
          position: 1,
          name: 'Ana Sayfa',
          item: import.meta.env.PUBLIC_SITE_URL,
        },
        {
          '@type': 'ListItem',
          position: 2,
          name: 'Blog',
          item: `${import.meta.env.PUBLIC_SITE_URL}/blog`,
        },
        {
          '@type': 'ListItem',
          position: 3,
          name: post.title.rendered,
          item: `${import.meta.env.PUBLIC_SITE_URL}/${post.slug}`,
        },
      ],
    }}
  />
  
  <slot />
</BaseLayout>

