---
import BaseLayout from '@layouts/BaseLayout.astro';
import PostGridPattern from '@components/blog/PostGridPattern.astro';
import { getCollection } from 'astro:content';
import { sortPostsByDate, filterPostsByCategory, getCategoryFromSlug, getCategorySEO, getCategoryLogo, getCategorySlug } from '@utils/content';

export async function getStaticPaths() {
  const entries = await getCollection('blog', ({ data }) => !data.draft);
  const blogSlugs = new Set<string>(entries.map(post => post.slug as string));
  
  const categories = new Set<string>();
  entries.forEach(post => {
    if (post.data.category) {
      categories.add(post.data.category);
    }
  });

  return Array.from(categories).map((category) => {
    // getCategorySlug fonksiyonunu kullan
    const finalSlug = getCategorySlug(category);
    
    // Blog yazısı slug'ı ile çakışıyorsa atla
    if (blogSlugs.has(finalSlug as string)) {
      return null;
    }
    
    return {
      params: { category: finalSlug },
      props: { categoryName: category }
    };
  }).filter(Boolean) as Array<{ params: { category: string }; props: { categoryName: string } }>;
}

const { category: categorySlug } = Astro.params;
const { categoryName } = Astro.props as { categoryName: string };

// Kategori adını kontrol et
const actualCategory = getCategoryFromSlug(categorySlug || '') || categoryName;

if (!actualCategory) {
  return Astro.redirect('/blog');
}

const entries = await getCollection('blog', ({ data }) => !data.draft);
const allPosts = sortPostsByDate(entries);
const categoryPosts = filterPostsByCategory(allPosts, actualCategory);

const seo = getCategorySEO(actualCategory);
const categoryLogo = getCategoryLogo(actualCategory);

const title = seo.title;
const description = seo.description;
const image = categoryLogo || '/images/workshop.jpg';
---

<BaseLayout title={title} description={description} image={image}>
  <!-- Hero Section - Kategori Başlığı -->
  <section class="relative min-h-[28vh] flex items-center justify-center overflow-hidden">
    {/* Background Image */}
    <div class="absolute inset-0">
      <img 
        src="/images/workshop.jpg" 
        alt={actualCategory} 
        class="w-full h-full object-cover"
        width="1920"
        height="1080"
      />
      <div class="absolute inset-0 bg-gradient-to-br from-navy/95 via-navy/90 to-navy/95"></div>
    </div>

    {/* Pattern */}
    <div class="absolute inset-0 opacity-10">
      <div class="absolute inset-0" style="background-image: url('data:image/svg+xml,%3Csvg width=\'60\' height=\'60\' viewBox=\'0 0 60 60\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cg fill=\'none\' fill-rule=\'evenodd\'%3E%3Cg fill=\'%231a9cb0\' fill-opacity=\'0.4\'%3E%3Cpath d=\'M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z\'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E');"></div>
    </div>
 
    <div class="container relative z-10 py-8">
      <div class="max-w-4xl mx-auto text-center">
        {/* Logo + Başlık */}
        <div class="flex items-center justify-center gap-4 mb-4" data-reveal>
          {categoryLogo && (
            <img 
              src={categoryLogo} 
              alt={actualCategory}
              class="w-16 h-16 md:w-20 md:h-20 object-contain filter brightness-0 invert"
            />
          )}
          <h1 class="text-3xl md:text-4xl lg:text-5xl font-display font-bold text-white">
            {actualCategory} <span class="text-transparent bg-clip-text bg-gradient-to-r from-primary via-cyan to-primary">Yazıları</span>
          </h1>
        </div>
        
        <p class="text-base md:text-lg text-gray-300 leading-relaxed max-w-3xl mx-auto" data-reveal>
          {description}
        </p>
      </div>
    </div>
  </section>

  <!-- Blog Grid -->
  <section class="section bg-gradient-to-b from-gray-50 to-white">
    <div class="container">
      {categoryPosts.length > 0 ? (
        <>
          <PostGridPattern posts={categoryPosts} />
          <div class="mt-12 text-center">
            <a 
              href="/blog" 
              class="inline-flex items-center gap-2 text-navy hover:text-primary font-semibold transition-colors"
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
              </svg>
              Tüm Yazılara Dön
            </a>
          </div>
        </>
      ) : (
        <div class="text-center py-20">
          <div class="relative inline-block mb-6">
            <div class="w-24 h-24 bg-gradient-to-br from-primary/20 to-cyan/20 rounded-2xl flex items-center justify-center mx-auto">
              <svg class="w-12 h-12 text-primary" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
              </svg>
            </div>
          </div>
          <h3 class="text-3xl font-display font-bold text-navy mb-4">{actualCategory} Kategorisinde Henüz Yazı Yok</h3>
          <p class="text-lg text-gray-600 mb-8 max-w-md mx-auto">
            Bu kategoride henüz yazı bulunmamaktadır.
          </p>
          <div class="flex gap-4 justify-center">
            <a href="/blog" class="btn bg-gradient-to-r from-primary to-cyan text-white hover:shadow-lg hover:shadow-primary/50 transition-all">
              Tüm Yazılar
            </a>
            <a href="/hizmetlerimiz" class="btn bg-white text-navy border-2 border-navy hover:bg-navy hover:text-white transition-all">
              Hizmetlerimiz
            </a>
          </div>
        </div>
      )}
    </div>
  </section>
</BaseLayout>

