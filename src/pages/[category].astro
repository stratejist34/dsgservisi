---
import BaseLayout from '@layouts/BaseLayout.astro';
import PostGridPattern from '@components/blog/PostGridPattern.astro';
import { getCollection } from 'astro:content';
import { sortPostsByDate, filterPostsByCategory, getCategoryFromSlug, getCategorySEO, getCategoryLogo, getCategorySlug, isPublishedPost } from '@utils/content';

export async function getStaticPaths() {
  const entries = await getCollection('blog', ({ data }) => isPublishedPost(data));
  const blogSlugs = new Set<string>(entries.map(post => post.slug as string));
  
  const categories = new Set<string>();
  entries.forEach(post => {
    if (post.data.category) {
      categories.add(post.data.category);
    }
  });

  return Array.from(categories).map((category) => {
    // getCategorySlug fonksiyonunu kullan
    const finalSlug = getCategorySlug(category);
    
    // Blog yazısı slug'ı ile çakışıyorsa atla
    if (blogSlugs.has(finalSlug as string)) {
      return null;
    }
    
    return {
      params: { category: finalSlug },
      props: { categoryName: category }
    };
  }).filter(Boolean) as Array<{ params: { category: string }; props: { categoryName: string } }>;
}

const { category: categorySlug } = Astro.params;
const { categoryName } = Astro.props as { categoryName: string };

// Kategori adını kontrol et
const actualCategory = getCategoryFromSlug(categorySlug || '') || categoryName;

if (!actualCategory) {
  return Astro.redirect('/blog');
}

const entries = await getCollection('blog', ({ data }) => isPublishedPost(data));
const allPosts = sortPostsByDate(entries);
const categoryPosts = filterPostsByCategory(allPosts, actualCategory);

const seo = getCategorySEO(actualCategory);
const categoryLogo = getCategoryLogo(actualCategory);

const title = seo.title;
const description = seo.description;
const image = categoryLogo || '/images/workshop.jpg';
---

<BaseLayout title={title} description={description} image={image}>
  <!-- Hero Section - Cyberpunk Tech Style -->
  <section class="relative min-h-[32vh] flex items-center justify-center overflow-hidden bg-[#0f172a] pt-20 pb-8">
    {/* Tech Background Elements */}
    <div class="absolute inset-0 pointer-events-none overflow-hidden">
      {/* Grid Overlay */}
      <div class="absolute inset-0 opacity-[0.03]" 
           style="background-image: linear-gradient(#fff 1px, transparent 1px), linear-gradient(90deg, #fff 1px, transparent 1px); background-size: 50px 50px;">
      </div>
      
      {/* Glowing Orbs */}
      <div class="absolute top-[-20%] right-[-10%] w-[500px] h-[500px] bg-amber-500/10 rounded-full blur-[120px] opacity-30"></div>
      <div class="absolute bottom-[-20%] left-[-10%] w-[400px] h-[400px] bg-slate-700/30 rounded-full blur-[100px] opacity-30"></div>
    </div>
 
    <div class="container relative z-10">
      <div class="max-w-4xl mx-auto text-center">
        {/* Tech Badge */}
        <div class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-white/5 border border-white/10 backdrop-blur-md mb-6" data-reveal>
          <span class="flex h-2 w-2 rounded-full bg-primary animate-pulse"></span>
          <span class="text-primary text-xs font-bold tracking-widest uppercase font-mono">CATEGORY</span>
          <span class="text-slate-400 text-xs uppercase tracking-widest border-l border-white/10 pl-2 ml-2">{categoryPosts.length} YAZI</span>
        </div>

        {/* Logo + Başlık */}
        <div class="flex items-center justify-center gap-4 mb-6" data-reveal>
          {categoryLogo && (
            <div class="relative">
              <div class="absolute inset-0 bg-primary/20 blur-xl rounded-full"></div>
              <img 
                src={categoryLogo} 
                alt={actualCategory}
                class="relative w-16 h-16 md:w-20 md:h-20 object-contain filter brightness-0 invert opacity-90"
              />
            </div>
          )}
          <h1 class="text-4xl md:text-5xl lg:text-6xl font-display font-bold text-white">
            {actualCategory} <span class="text-primary">Yazıları</span>
          </h1>
        </div>
        
        <p class="text-base md:text-lg text-slate-400 leading-relaxed max-w-3xl mx-auto" data-reveal>
          {description}
        </p>
      </div>
    </div>
    
    {/* Bottom Tech Line */}
    <div class="absolute bottom-0 left-0 right-0 h-px bg-gradient-to-r from-transparent via-white/10 to-transparent"></div>
  </section>

  <!-- Blog Grid -->
  <section class="section relative bg-[#0f172a] overflow-hidden">
    {/* Subtle Background Elements */}
    <div class="absolute inset-0 pointer-events-none">
      <div class="absolute top-0 left-1/4 w-[500px] h-[500px] bg-amber-500/5 rounded-full blur-[150px]"></div>
      <div class="absolute bottom-0 right-1/4 w-[400px] h-[400px] bg-slate-700/30 rounded-full blur-[120px]"></div>
    </div>
    
    <div class="container relative z-10">
      {categoryPosts.length > 0 ? (
        <>
          <PostGridPattern posts={categoryPosts} />
          <div class="mt-12 text-center">
            <a 
              href="/blog" 
              class="inline-flex items-center gap-2 px-6 py-3 rounded-xl bg-slate-800/50 border border-white/10 text-slate-300 hover:text-primary hover:border-primary/50 font-semibold transition-all"
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
              </svg>
              Tüm Yazılara Dön
            </a>
          </div>
        </>
      ) : (
        <div class="text-center py-20">
          <div class="relative inline-block mb-6">
            <div class="w-24 h-24 bg-gradient-to-br from-primary/20 to-amber-600/20 rounded-2xl flex items-center justify-center mx-auto border border-white/10">
              <svg class="w-12 h-12 text-primary" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
              </svg>
            </div>
          </div>
          <h3 class="text-3xl font-display font-bold text-white mb-4">{actualCategory} Kategorisinde Henüz Yazı Yok</h3>
          <p class="text-lg text-slate-400 mb-8 max-w-md mx-auto">
            Bu kategoride henüz yazı bulunmamaktadır.
          </p>
          <div class="flex gap-4 justify-center">
            <a href="/blog" class="btn bg-gradient-to-r from-primary to-amber-600 text-white hover:shadow-lg hover:shadow-primary/50 transition-all px-6 py-3 rounded-xl font-semibold">
              Tüm Yazılar
            </a>
            <a href="/hizmetlerimiz" class="btn bg-slate-800/50 text-white border border-white/20 hover:bg-slate-700 hover:border-primary/50 transition-all px-6 py-3 rounded-xl font-semibold">
              Hizmetlerimiz
            </a>
          </div>
        </div>
      )}
    </div>
  </section>
</BaseLayout>

