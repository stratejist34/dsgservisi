---
import BlogLayout from '@layouts/BlogLayout.astro';
import { fetchPostBySlug, getAllPostSlugs, cleanWPContent, getFeaturedImageUrl } from '@utils/wordpress';

export async function getStaticPaths() {
  try {
    const slugs = await getAllPostSlugs();
    return slugs.map((slug) => ({
      params: { slug },
    }));
  } catch (error) {
    console.log('WordPress API not available, skipping posts');
    return [];
  }
}

const { slug } = Astro.params;
const post = await fetchPostBySlug(slug as string);

// Redirect to 404 if post not found
if (!post) {
  return Astro.redirect('/404');
}

const featuredImage = getFeaturedImageUrl(post);
const cleanContent = cleanWPContent(post.content.rendered);
---

<BlogLayout post={post}>
  <!-- Article Header -->
  <article class="py-12 bg-white" style="overflow: visible;">
    <div class="container max-w-7xl" style="overflow: visible;">
      <!-- Breadcrumb -->
      <nav class="flex items-center text-sm text-gray-600 mb-8">
        <a href="/" class="hover:text-primary transition-colors">Ana Sayfa</a>
        <svg class="w-4 h-4 mx-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
        </svg>
        <a href="/blog" class="hover:text-primary transition-colors">Blog</a>
        <svg class="w-4 h-4 mx-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
        </svg>
        <span class="text-gray-400 truncate">{post.title.rendered}</span>
      </nav>

      <!-- Title -->
      <h1 class="font-display font-bold text-navy mb-8">
        {post.title.rendered}
      </h1>

      <!-- Featured Image -->
      <div class="mb-12 rounded-2xl overflow-hidden shadow-2xl">
        <img
          src={featuredImage}
          alt={post.title.rendered}
          class="w-full h-auto"
          loading="eager"
        />
      </div>

      <!-- Content with TOC -->
      <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 relative" style="overflow: visible;">
        <!-- Main Content - 62% (8 cols) -->
        <div
          class="lg:col-span-8 prose prose-lg max-w-none
            prose-headings:font-display prose-headings:font-bold prose-headings:text-navy
            prose-h2:text-3xl prose-h2:mt-12 prose-h2:mb-6 prose-h2:scroll-mt-24
            prose-h3:text-2xl prose-h3:mt-8 prose-h3:mb-4
            prose-p:text-gray-700 prose-p:leading-relaxed prose-p:mb-6
            prose-a:text-primary prose-a:no-underline hover:prose-a:text-cyan hover:prose-a:underline
            prose-strong:text-navy prose-strong:font-semibold
            prose-ul:my-6 prose-li:my-2
            prose-img:rounded-xl prose-img:shadow-lg
            prose-blockquote:border-l-4 prose-blockquote:border-primary prose-blockquote:pl-6 prose-blockquote:italic prose-blockquote:text-gray-600"
          set:html={cleanContent}
          id="article-content"
        />

        <!-- Table of Contents - 38% (4 cols) - Sticky -->
        <aside class="lg:col-span-4" style="position: relative; overflow: visible;">
          <div style="position: -webkit-sticky; position: sticky; top: 6rem; max-height: calc(100vh - 8rem); overflow-y: auto; z-index: 10;" class="hidden lg:block">
            <div class="bg-gradient-to-br from-primary/10 to-cyan/10 rounded-2xl p-6 border-2 border-primary/20 shadow-lg">
              <div class="flex items-center gap-2 mb-4">
                <svg class="w-5 h-5 text-primary" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h7" />
                </svg>
                <h3 class="font-display font-bold text-navy text-lg">İçindekiler</h3>
              </div>
              <nav id="toc" class="space-y-2">
                <!-- TOC will be populated by JavaScript -->
              </nav>
            </div>
          </div>
        </aside>
      </div>

      <script>
        // Generate Table of Contents from H2 tags
        document.addEventListener('DOMContentLoaded', () => {
          const content = document.getElementById('article-content');
          const toc = document.getElementById('toc');
          
          if (content && toc) {
            const headings = content.querySelectorAll('h2');
            
            if (headings.length > 0) {
              headings.forEach((heading, index) => {
                // Add ID to heading for anchor links
                const id = `heading-${index}`;
                heading.id = id;
                
                // Create TOC item
                const tocItem = document.createElement('a');
                tocItem.href = `#${id}`;
                tocItem.className = 'block py-2 px-4 text-gray-700 hover:text-primary hover:bg-white/50 rounded-lg transition-all duration-200 font-medium text-sm';
                tocItem.textContent = heading.textContent || '';
                
                // Smooth scroll
                tocItem.addEventListener('click', (e) => {
                  e.preventDefault();
                  heading.scrollIntoView({ behavior: 'smooth', block: 'start' });
                  history.pushState(null, '', `#${id}`);
                });
                
                toc.appendChild(tocItem);
              });
            } else {
              // If no H2 headings, hide TOC
              toc.closest('aside')?.classList.add('hidden');
            }
          }
        });
      </script>
    </div>
  </article>

  <!-- CTA Section -->
  <section class="section bg-gradient-to-br from-navy to-navy-700 text-white">
    <div class="container max-w-7xl">
      <div class="text-center">
        <h2 class="font-display font-bold mb-6">
          Profesyonel Volkswagen Özel Servisi
        </h2>
        <p class="text-xl text-gray-300 mb-8">
          DSG şanzıman ve mekatronik konusunda uzman ekibimizle tanışın
        </p>
        <div class="flex flex-col sm:flex-row gap-4 justify-center">
          <a href="/iletisim" class="btn btn-primary btn-lg">
            Randevu Alın
          </a>
          <a href="/hizmetlerimiz" class="btn bg-white text-navy hover:bg-gray-100 btn-lg">
            Hizmetlerimiz
          </a>
        </div>
      </div>
    </div>
  </section>
</BlogLayout>

